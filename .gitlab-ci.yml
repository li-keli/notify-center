before_script:
  - echo " CI is running... "

# ç¼–è¯‘é¡¹ç›®
project-build:
  stage: build
  tags:
    - build
  only:
    - /^preview\/.*$/
    - /^release\/.*$/
  script:
    - docker run -i --rm -v $(pwd):/usr/work -w /usr/work docker.jsjit.cn/golang:1.12 ./deploy.sh
    - export GIN_MODE=debug
    - export REPLICAS=1
    - export VERSION=$(git --no-pager log -n 1 --no-merges --pretty=format:"%h" HEAD)
    - docker-compose build
    - docker-compose push

# ******************************************************************************************************
# ************************************** æµ‹è¯•çŽ¯å¢ƒé…ç½® ****************************************************
# ******************************************************************************************************
notify-center-test-deploy:
  stage: deploy
  tags:
    - build
  only:
    - /^preview\/.*$/
  environment:
    name: testing
  script:
    - export VERSION=$(git --no-pager log -n 1 --no-merges --pretty=format:"%h" HEAD)
    - docker stack deploy --compose-file docker-compose.yml -c docker-compose-test.yml --with-registry-auth notify-center
    - AUTHOR=$(git --no-pager log -n 1 --no-merges --pretty=format:"%an" HEAD)
    - MESSAGE=$(git --no-pager log -n 1 --no-merges --pretty=format:"%s" HEAD)
    - MSG="ã€æŽ¨é€ç½‘å…³V2ã€‘\nå‘å¸ƒçŽ¯å¢ƒï¼šðŸŸ¡ æµ‹è¯•çŽ¯å¢ƒ \nå‘å¸ƒè€…ï¼š$AUTHOR \nç‰ˆæœ¬hashï¼š$VERSION \næ›´æ–°æ—¥å¿—ï¼š$MESSAGE"
    - >
      curl 'https://oapi.dingtalk.com/robot/send?access_token=784334b948516948bcbf062d811f0d2c18ac7303367daf7fc61afdca917ae234'
      -H 'Content-Type: application/json'
      -d '{"msgtype":"text","text":{"content":"'"$MSG"'"}}'

# ******************************************************************************************************
# ************************************** ç”Ÿäº§çŽ¯å¢ƒé…ç½® ****************************************************
# ******************************************************************************************************
notify-center-prod:
  stage: deploy
  tags:
    - release
  only:
    - release/2.0
  environment:
    name: production
  script:
    - export VERSION=$(git --no-pager log -n 1 --no-merges --pretty=format:"%h" HEAD)
    - docker stack deploy --compose-file docker-compose.yml -c docker-compose-v2.0.yml --with-registry-auth notify-center
    - AUTHOR=$(git --no-pager log -n 1 --no-merges --pretty=format:"%an" HEAD)
    - MESSAGE=$(git --no-pager log -n 1 --no-merges --pretty=format:"%s" HEAD)
    - MSG="ã€æŽ¨é€ç½‘å…³V2ã€‘\nå‘å¸ƒçŽ¯å¢ƒï¼šðŸŸ¢ ç”Ÿäº§çŽ¯å¢ƒ \nå‘å¸ƒè€…ï¼š$AUTHOR \nç‰ˆæœ¬hashï¼š$VERSION \næ›´æ–°æ—¥å¿—ï¼š$MESSAGE"
    - >
      curl 'https://oapi.dingtalk.com/robot/send?access_token=784334b948516948bcbf062d811f0d2c18ac7303367daf7fc61afdca917ae234'
      -H 'Content-Type: application/json'
      -d '{"msgtype":"text","text":{"content":"'"$MSG"'"}}'
